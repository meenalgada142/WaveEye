```markdown
# WaveEye – Preprocessing Pipeline

This module prepares raw simulation waveforms for **WaveEye’s RTL analysis engine**.  
It converts simulator outputs into a **normalized, analysis-ready CSV format** consumed by the `ir_engine` executable.[web:24]

⚠️ **This step is mandatory** before running the IR backtracking and bug-reasoning engine.[web:24]

---

## What This Stage Does

The preprocessing pipeline:

- Parses raw waveform dumps (VCD / CSV / simulator exports).[web:24]
- Normalizes signal names and hierarchy.[web:24]
- Classifies signals (clock, reset, data, control).[web:24]
- Aligns timebases (`time_ps`, `time_ns`, etc.).[web:24]
- Produces a **single merged waveform CSV**: `all_mapped_values.csv`.[web:24]

This file is the **only waveform input** expected by the IR engine along with the original RTL files.[web:24]

---

## Folder Structure

```bash
Preprocessing/
├── cli.py                  # Preprocessing entry point (invoked by user / main.py)
├── main.py                 # Internal preprocessing orchestration
│
├── mapping/                # Signal mapping & waveform normalization
│   ├── mapping.py
│   ├── mapping_values.py
│   ├── merge_map_signals.py
│   └── __pycache__/
│
├── rtl/                    # RTL-aware preprocessing & classification
│   ├── check_system.py
│   ├── classify_signals.py
│   └── classify_system.py
│
├── uploaded_vcds/          # Raw user-uploaded VCDs
├── user_input/             # User-provided CSVs / configs
├── vcd/                    # Expanded / intermediate VCD processing
└── README.md               # Preprocessing documentation

```

---

## Requirements

- Python 3.9 or newer.[web:24]  
- `pandas` library.[web:24]

Install dependencies:

```bash
pip install pandas
```

---

## Usage

### Run Preprocessing

From the WaveEye root directory:

```bash
python Preprocessing/cli.py
```

Examples:

```bash
# VCD file
python Preprocessing/cli.py dump.vcd

# Simulator-generated CSV
python Preprocessing/cli.py raw_waveform.csv
```

### Output Layout

Preprocessing creates a user-scoped output directory:

```bash
outputs/
└── <user>/
    └── preprocessing/
        ├── all_mapped_values.csv   # REQUIRED by ir_engine
        └── metadata.json
```

❗ **Do not rename** `all_mapped_values.csv`.  
The IR engine relies on this exact filename and its location under `outputs/<user>/preprocessing/`.[web:24]

---

## Output CSV Format

The generated CSV has a strict structure:

- **Row 0**: Signal classification  
  - e.g. `clock`, `reset_active_low`, `data`, `control`, …
- **Row 1**: Signal names
- **Row 2+**: Time-ordered waveform samples

Example:

```bash
# all_mapped_values.csv (conceptual content)
clock,reset_active_low,data
time_ps,clk,rst_n,valid
0,0,0,0
5,1,0,0
```

Notes:

- First column is the time column (e.g. `time_ps`).  
- Remaining columns are signal values at that timestamp.  
- Time values must be monotonically non-decreasing and use a single normalized timebase.[web:24]

This format is contractually expected by:

- `rising_falling_edges.py`
- `stuck_signals.py`
- `ir_engine` (main pipeline)[web:24]

---

## Integration With the IR Engine

Overall execution flow:

```bash
# Conceptual pipeline
Preprocessing/cli.py  # produces all_mapped_values.csv
ir_engine.exe         # consumes all_mapped_values.csv + RTL
```

High-level data path:

```bash
Preprocessing (cli.py)
        ↓
all_mapped_values.csv
        ↓
ir_engine.exe
        ↓
RTL backtracking + NBA race detection + stuck signal reasoning
```

If preprocessing is skipped, incorrect, or the CSV is modified, the IR engine will fail or produce invalid analysis.[web:24]

---

## Common Mistakes

Avoid:

- Running `ir_engine` directly on raw VCD/CSV without preprocessing.  
- Renaming `all_mapped_values.csv`.  
- Moving the CSV out of `outputs/<user>/preprocessing/`.  
- Editing the CSV manually in Excel or other tools.[web:24]

---

## Troubleshooting

### IR engine cannot find waveform

Check the file exists:

```bash
ls outputs/<user>/preprocessing/all_mapped_values.csv
```

If missing, rerun preprocessing with the correct `<user>` context.[web:24]

### Clock or reset not detected

Inspect the header rows:

```bash
head -n 2 outputs/<user>/preprocessing/all_mapped_values.csv
```

Verify:

- Clock/reset signals appear in row 1 (signal names).  
- Their classes in row 0 are correct (e.g. `clock`, `reset_active_low`).[web:24]

---

## Summary

- Preprocessing converts simulator waveforms into a strict CSV contract for the IR engine.  
- `all_mapped_values.csv` is mandatory, must not be renamed, moved, or edited.  
- This README belongs in the `Preprocessing/` folder of the WaveEye repository.[web:24]
```
